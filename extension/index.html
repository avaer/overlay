<!doctype html>
<html>
<head>
<script src="three.min.js"></script>
<style>
body {
  margin: 0;
}
.body {
  display: flex;
}
.body section {
  display: flex;
  flex: 1;
  flex-direction: column;
  overflow: hidden;
  white-space: nowrap;
}
h1, .body section {
  padding: 0 30px;
}
a {
  text-decoration: underline;
  color: #64b5f6;
  cursor: pointer;
}
a:active {
  color: #1e88e5;
}
#canvas-2d {
  position: fixed;
  left: 0;
  bottom: 0;
  pointer-events: none;
}
</style>
</head>
<body>
  <h1>Home Launcher (OpenVR)</h1>
  <div class=body>
    <section id=apps>
      <h2>Steam Apps</h2>
    </section>
    <section id=processes>
      <h2>Processes</h2>
    </section>
  </div>
  <div class=body>
    <section id=sites>
      <h2>Web Sites</h2>
      <a href="https://immersive-web.github.io/webxr-samples/">WebXR Samples</a>
      <a href="https://immersive-web.github.io/webxr-samples/positional-audio.html">Positional Audio</a>
    </section>
  </div>
  <div class=body>
    <input type=button id=toggle-controls-button value="FPS controls">
  </div>
  <canvas width=500 height=500 id=canvas-2d></canvas>
<script>

const _fakeXrChrome = {
  async request() {},
};
const xrc = () => window.xrchrome ? window.xrchrome : _fakeXrChrome;

window.addEventListener('xrchromeloaded', async () => {
  const executables = await xrc().request('listSteamApps', []);
  for (const exe of executables) {
    const a = document.createElement('a');
    a.setAttribute('src', `file://${exe}`);
    a.innerHTML = exe;
    a.addEventListener('click', async e => {
      e.preventDefault();

      const res = await xrc().request('launchApp', [
        exe,
      ]);
      const {processId} = res;

      {
        const a2 = document.createElement('a');
        a2.setAttribute('src', `file://${processId}`);
        a2.innerHTML = processId + '';
        a2.addEventListener('click', async e => {
          e.preventDefault();

          await xrc().request('killApp', [
            processId,
          ]);
        });
        document.getElementById('processes').appendChild(a2);
      }
    });
    document.getElementById('apps').appendChild(a);
  }
});
document.addEventListener('pointerlockchange', async e => {
  const isVr = !document.pointerLockElement;
  await xrc().request('setIsVr', [isVr]);
});
const position = new THREE.Vector3();
const rotation = new THREE.Euler(0, 0, 0, 'YXZ');
const quaternion = new THREE.Quaternion();
const scale = new THREE.Vector3();
document.addEventListener('mousemove', async e => {
  if (document.pointerLockElement) {
    console.log('got mouse move', e.movementX, e.movementY);

    rotation.y = (rotation.y + -e.movementX * Math.PI*2 * 0.01) % Math.PI*2;
    rotation.x += (rotation.x + -e.movementY * Math.PI*2 * 0.01) % Math.PI*2;
    quaternion.setFromEuler(rotation);

    await xrc().request('setTransform', [
      position.toArray(),
      quaternion.toArray(),
      scale.toArray(),
    ]);
  }
});
window.addEventListener('load', () => {
  const toggleControlsButton = document.getElementById('toggle-controls-button');
  toggleControlsButton.addEventListener('click', async () => {
    await window.document.body.requestPointerLock();
  });

  const canvas2d = document.getElementById('canvas-2d');
  const ctx = canvas2d.getContext('webgl2');
  function recurse() {
    ctx.clear(ctx.COLOR_BUFFER_BIT);
    // console.log('clear');
    // ctx2d.clearRect(0, 0, canvas2d.width, canvas2d.height);
    window.requestAnimationFrame(recurse);
  }
  window.requestAnimationFrame(recurse);
});

</script>
</body>
</html>